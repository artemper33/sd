<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Thai Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --hint-color: #707579;
            --button-color: #3390ec;
            --secondary-bg: #f4f4f5;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            overflow-x: hidden;
        }

        .container { padding: 15px; min-height: 100vh; box-sizing: border-box; }
        .hidden { display: none; }

        h2 { margin-top: 0; font-size: 22px; }
        .back-btn {
            border: none; background: none; color: var(--button-color);
            padding: 0; margin-bottom: 15px; font-size: 16px; cursor: pointer;
        }

        .categories-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .category-card {
            background: var(--secondary-bg); border-radius: 12px; padding: 15px;
            text-align: center; cursor: pointer; transition: transform 0.1s;
        }
        .category-card:active { transform: scale(0.97); }
        .category-card img { width: 60px; height: 60px; object-fit: contain; border-radius: 8px; }

        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .product-card {
            background: var(--secondary-bg); border-radius: 12px; padding: 10px;
            text-align: center; display: flex; flex-direction: column; justify-content: space-between;
        }
        .product-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; }
        .product-title { font-size: 13px; margin: 8px 0; height: 40px; overflow: hidden; line-height: 1.2; }
        .price { font-weight: bold; color: var(--button-color); margin-bottom: 8px; }
        
        .btn-add {
            background: var(--button-color); color: white; border: none;
            padding: 8px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }

        .cart-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #eee;
        }
        .qty-controls { display: flex; align-items: center; gap: 12px; }
        .btn-qty {
            background: #e1e1e3; border: none; width: 32px; height: 32px;
            border-radius: 50%; font-weight: bold; cursor: pointer; font-size: 18px;
        }

        .order-form { background: var(--secondary-bg); border-radius: 12px; padding: 15px; margin-top: 10px; }
        .order-form input {
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px;
            border: 1px solid #ccc; box-sizing: border-box; font-size: 16px;
        }
    </style>
</head>
<body>

<div class="container" id="screen-categories">
    <h2>Категории</h2>
    <div id="categories-list" class="categories-grid"></div>
</div>

<div class="container hidden" id="screen-products">
    <button class="back-btn" onclick="showCategories()">← Назад</button>
    <h2 id="category-title">Товары</h2>
    <div id="products-list" class="products-grid"></div>
</div>

<div class="container hidden" id="screen-cart">
    <button class="back-btn" onclick="goBackFromCart()">← В магазин</button>
    <h2>Корзина</h2>
    <div id="cart-items"></div>
    <div id="cart-total-price" style="text-align:right; font-weight:bold; font-size:20px; margin-top:15px; border-top: 1px solid #eee; padding-top:15px;"></div>
</div>

<div class="container hidden" id="screen-checkout">
    <button class="back-btn" onclick="showCart()">← В корзину</button>
    <h2>Оформление</h2>
    <div class="order-form">
        <input type="text" id="user-fio" placeholder="ФИО">
        <input type="tel" id="user-phone" placeholder="Телефон">
        <input type="text" id="user-address" placeholder="Адрес доставки">
    </div>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGfB1K76W8TlRCOzb-J-r0abekSgiiFJvBbzEr51PaKUu-stO_TmAHUQGUQ2rhlO0_gBmue4D0ioLH/pub?output=csv';

    let allProducts = [];
    let cart = {};
    let currentScreen = 'categories';
    let lastCategory = '';

    function saveCart() { localStorage.setItem('thai_shop_cart', JSON.stringify(cart)); }
    function loadCartFromStorage() {
        const saved = localStorage.getItem('thai_shop_cart');
        if (saved) { try { cart = JSON.parse(saved); updateMainButton(); } catch(e) {} }
    }

    async function loadData() {
        try {
            const res = await fetch(SHEET_URL);
            const csvText = await res.text();
            const rows = [];
            let currentToken = "", inQuotes = false, currentRow = [];

            for (let i = 0; i < csvText.length; i++) {
                let char = csvText[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { currentRow.push(currentToken.trim()); currentToken = ""; }
                else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentToken || currentRow.length > 0) { currentRow.push(currentToken.trim()); rows.push(currentRow); }
                    currentToken = ""; currentRow = [];
                    if (char === '\r' && csvText[i+1] === '\n') i++;
                } else currentToken += char;
            }

            allProducts = rows.slice(1).map(cols => ({
                cat: (cols[0] || "").replace(/^"|"$/g, ''),
                name: (cols[1] || "").replace(/^"|"$/g, ''),
                price: parseInt(cols[2]) || 0,
                img: (cols[3] || "").replace(/^"|"$/g, ''),
                cat_img: (cols[4] || "").replace(/^"|"$/g, '')
            })).filter(p => p.name && p.price > 0);

            renderCategories();
            loadCartFromStorage();
        } catch (e) { console.error(e); }
    }

    function renderCategories() {
        const list = document.getElementById('categories-list');
        const cats = [...new Set(allProducts.map(p => p.cat))];
        list.innerHTML = '';
        cats.forEach(cat => {
            const p = allProducts.find(item => item.cat === cat);
            const card = document.createElement('div');
            card.className = 'category-card';
            card.onclick
