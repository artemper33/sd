<div class="container hidden" id="screen-cart">
    <button onclick="goBackFromCart()" style="border:none; background:none; color:var(--button-color); font-size:16px; margin-bottom:15px;">← Назад</button>
    <h2>Корзина</h2>
    <div id="cart-items"></div>
    <div id="cart-total-price" style="text-align:right; font-weight:bold; font-size:20px; margin-top:15px; border-top: 1px solid #ddd; padding-top:10px;"></div>
</div>

<div class="container hidden" id="screen-checkout">
    <button onclick="showCart()" style="border:none; background:none; color:var(--button-color); font-size:16px; margin-bottom:15px;">← В корзину</button>
    <h2>Доставка</h2>
    <div class="order-form">
        <input type="text" id="user-fio" placeholder="ФИО">
        <input type="tel" id="user-phone" placeholder="Номер телефона">
        <input type="text" id="user-address" placeholder="Адрес доставки">
    </div>
</div>

<style>
    /* Добавим стили для кнопок +/- в корзине */
    .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
    .qty-controls { display: flex; align-items: center; gap: 10px; }
    .btn-qty { 
        background: var(--secondary-bg); border: none; width: 30px; height: 30px; 
        border-radius: 50%; font-weight: bold; cursor: pointer; 
    }
</style>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGfB1K76W8TlRCOzb-J-r0abekSgiiFJvBbzEr51PaKUu-stO_TmAHUQGUQ2rhlO0_gBmue4D0ioLH/pub?output=csv';

    let allProducts = [];
    let cart = {};
    let currentScreen = 'categories'; 

    async function loadData() {
        try {
            const response = await fetch(SHEET_URL);
            const data = await response.text();
            const rows = data.split('\n').map(row => row.trim()).filter(row => row.length > 0).slice(1);
            allProducts = rows.map(row => {
                const cols = row.split(',');
                return { cat: cols[0], name: cols[1], price: parseInt(cols[2]), img: cols[3], cat_img: cols[4] };
            }).filter(p => p.name && p.price);
            renderCategories();
        } catch (e) { console.error(e); }
    }

    function renderCategories() {
        const list = document.getElementById('categories-list');
        const cats = [...new Set(allProducts.map(p => p.cat))];
        list.innerHTML = '';
        cats.forEach(cat => {
            const p = allProducts.find(item => item.cat === cat);
            const card = document.createElement('div');
            card.className = 'category-card';
            card.onclick = () => showProducts(cat);
            card.innerHTML = `<img src="${p.cat_img}"><div style="margin-top:8px; font-weight:bold;">${cat}</div>`;
            list.appendChild(card);
        });
    }

    function showProducts(cat) {
        currentScreen = 'products';
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById('screen-products').classList.remove('hidden');
        const list = document.getElementById('products-list');
        list.innerHTML = '';
        allProducts.filter(p => p.cat === cat).forEach(p => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <img src="${p.img}">
                <h4>${p.name}</h4>
                <div class="price">${p.price} ₽</div>
                <button class="btn-add" onclick="changeQty('${p.name}', 1, ${p.price})">Добавить</button>
            `;
            list.appendChild(card);
        });
        updateMainButton();
    }

    // Универсальная функция изменения количества
    function changeQty(name, delta, price) {
        if (!cart[name]) {
            if (delta > 0) cart[name] = { price: price, count: delta };
        } else {
            cart[name].count += delta;
            if (cart[name].count <= 0) delete cart[name];
        }
        
        if (currentScreen === 'cart') renderCartItems();
        updateMainButton();
    }

    function updateMainButton() {
        const count = Object.values(cart).reduce((a, b) => a + b.count, 0);
        if (count > 0) {
            if (currentScreen === 'cart') tg.MainButton.setText("ПЕРЕЙТИ К ОФОРМЛЕНИЮ");
            else if (currentScreen === 'checkout') tg.MainButton.setText("ПОДТВЕРДИТЬ И ОПЛАТИТЬ");
            else tg.MainButton.setText(`КОРЗИНА (${count})`);
            tg.MainButton.show();
        } else {
            tg.MainButton.hide();
        }
    }

    function renderCartItems() {
        const list = document.getElementById('cart-items');
        list.innerHTML = '';
        let total = 0;
        for (const [name, info] of Object.entries(cart)) {
            const sum = info.price * info.count;
            total += sum;
            list.innerHTML += `
                <div class="cart-item">
                    <div>
                        <div style="font-weight:bold;">${name}</div>
                        <div style="color:var(--button-color);">${info.price} ₽</div>
                    </div>
                    <div class="qty-controls">
                        <button class="btn-qty" onclick="changeQty('${name}', -1, ${info.price})">-</button>
                        <span>${info.count}</span>
                        <button class="btn-qty" onclick="changeQty('${name}', 1, ${info.price})">+</button>
                    </div>
                </div>`;
        }
        document.getElementById('cart-total-price').innerText = `Итого: ${total} ₽`;
    }

    function showCart() {
        currentScreen = 'cart';
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById('screen-cart').classList.remove('hidden');
        renderCartItems();
        updateMainButton();
    }

    function showCheckout() {
        currentScreen = 'checkout';
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById('screen-checkout').classList.remove('hidden');
        updateMainButton();
    }

    tg.onEvent('mainButtonClicked', () => {
        if (currentScreen === 'categories' || currentScreen === 'products') {
            showCart();
        } else if (currentScreen === 'cart') {
            showCheckout();
        } else if (currentScreen === 'checkout') {
            const fio = document.getElementById('user-fio').value;
            const phone = document.getElementById('user-phone').value;
            const address = document.getElementById('user-address').value;
            if (!fio || !phone || !address) {
                tg.showAlert("Заполните все данные доставки!");
                return;
            }
            tg.sendData(JSON.stringify({ products: cart, customer: { fio, phone, address } }));
        }
    });

    loadData();
</script>
