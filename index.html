<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Thai Shop Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #f4f1ee; --card-bg: #ffffff; --text-main: #1a1a1a;
            --accent-green: #4b6a51; --radius: 30px; --shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg-color); margin: 0; padding: 0; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; min-height: 100vh; }
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: white; border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); position: relative; }
        .image-wrapper { width: 100%; aspect-ratio: 1/1; background: #f1f1f1; border-radius: 20px; overflow: hidden; margin-bottom: 10px; }
        .image-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .title { font-size: 14px; font-weight: 600; height: 36px; overflow: hidden; margin-bottom: 8px; }
        .price { font-weight: 700; font-size: 16px; }
        .btn-add { background: var(--accent-green); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; float: right; cursor: pointer; }
        .back-btn { cursor: pointer; color: var(--accent-green); margin-bottom: 15px; font-weight: bold; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #ddd; box-sizing: border-box; }
        .cart-item { display: flex; justify-content: space-between; margin-bottom: 10px; background: white; padding: 10px; border-radius: 15px; }
    </style>
</head>
<body>
    <div id="screen-cats" class="container">
        <h2>Каталог</h2>
        <div id="cats-list" class="grid"></div>
    </div>

    <div id="screen-prods" class="container hidden">
        <div class="back-btn" onclick="showScreen('screen-cats')">← Назад</div>
        <h2 id="cat-title"></h2>
        <div id="prods-list" class="grid"></div>
    </div>

    <div id="screen-cart" class="container hidden">
        <div class="back-btn" onclick="showScreen('screen-prods')">← В магазин</div>
        <h2>Корзина</h2>
        <div id="cart-list"></div>
        <h3 id="total-price"></h3>
        <hr>
        <input type="text" id="fio" placeholder="ФИО">
        <input type="tel" id="tel" placeholder="Телефон">
        <input type="text" id="adr" placeholder="Адрес доставки">
    </div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();
    let allItems = [], cart = {}, curCat = '';
    const CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGfB1K76W8TlRCOzb-J-r0abekSgiiFJvBbzEr51PaKUu-stO_TmAHUQGUQ2rhlO0_gBmue4D0ioLH/pub?output=csv';

    async function load() {
        const res = await fetch(CSV + '&t=' + Date.now());
        const text = await res.text();
        const rows = text.split('\n').slice(1);
        allItems = rows.map(r => {
            const c = r.split(',');
            return { cat: c[0]?.trim(), name: c[1]?.trim(), price: parseInt(c[2]) || 0, img: c[3]?.trim(), cImg: c[4]?.trim() };
        }).filter(i => i.name);
        renderCats();
    }

    function renderCats() {
        const cats = [...new Set(allItems.map(i => i.cat))];
        document.getElementById('cats-list').innerHTML = cats.map(c => {
            const i = allItems.find(item => item.cat === c);
            return `<div class="card" onclick="showProds('${c}')"><div class="image-wrapper"><img src="${i.cImg}"></div><div class="title">${c}</div></div>`;
        }).join('');
    }

    function showProds(c) {
        curCat = c; showScreen('screen-prods');
        document.getElementById('cat-title').innerText = c;
        document.getElementById('prods-list').innerHTML = allItems.filter(i => i.cat === c).map(i => `
            <div class="card">
                <div class="image-wrapper"><img src="${i.img}"></div>
                <div class="title">${i.name}</div>
                <div class="price">${i.price} ₽ <button class="btn-add" onclick="add('${i.name}',${i.price})">+</button></div>
            </div>`).join('');
    }

    function add(n, p) {
        cart[n] = cart[n] ? {p:p, q:cart[n].q+1} : {p:p, q:1};
        tg.MainButton.setText(`КОРЗИНА (${Object.values(cart).reduce((a,b)=>a+b.q,0)})`);
        tg.MainButton.show();
    }

    function showCart() {
        showScreen('screen-cart');
        let total = 0;
        document.getElementById('cart-list').innerHTML = Object.entries(cart).map(([n, i]) => {
            total += i.p * i.q;
            return `<div class="cart-item"><span>${n} (x${i.q})</span><b>${i.p*i.q} ₽</b></div>`;
        }).join('');
        document.getElementById('total-price').innerText = `Итого: ${total} ₽`;
        tg.MainButton.setText("ПОДТВЕРДИТЬ ЗАКАЗ");
    }

    function send() {
        const fio = document.getElementById('fio').value, tel = document.getElementById('tel').value, adr = document.getElementById('adr').value;
        if(!fio || !tel || !adr) return tg.showAlert("Заполните форму!");
        
        let orderItems = Object.entries(cart).map(([n, i]) => ({ n: n, q: i.q, p: i.p }));
        let total = orderItems.reduce((a, b) => a + (b.p * b.q), 0);

        tg.sendData(JSON.stringify({
            products: orderItems,
            total: total,
            user: { fio: fio, tel: tel, adr: adr }
        }));
    }

    tg.onEvent('mainButtonClicked', () => {
        if(document.getElementById('screen-cart').classList.contains('hidden')) showCart();
        else send();
    });

    function showScreen(id) {
        document.querySelectorAll('.container').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    load();
</script>
</body>
</html>
